---
title: "cs10: Satellite Remote Sensing"
format: html
editor: visual
---

# **Overview**

## **1. Introduction**

In this case study, youâ€™ll explore how satellite remote sensing can reveal spatial and temporal patterns in **Land Surface Temperature (LST)** and **Land Cover (LULC)** using MODIS data products.

By the end of this lab, you will: - Read and interpret data stored in **NetCDF** format\
- Extract and analyze time series from satellite data\
- Calculate **monthly climatologies**\
- Compare **LST across land cover types**

Youâ€™ll work primarily with two MODIS datasets: - **MOD11A2**: Land Surface Temperature (1 km, 8-day composite) - **MCD12Q1**: Land Cover Type (annual classification)

# **Setup and Data Download**

Youâ€™ll need both `MOD11A2` (LST) and `MCD12Q1` (Land Cover) NetCDF files.

### **ðŸ’¡ Hints:**

-   Load key packages: `terra`, `tidyverse`, `sf`, and `ncdf4`

-   Create a `data` folder for downloads using `dir.create("data", showWarnings = FALSE)`

-   Download the `.nc` files from the provided GitHub URLs

-   Store them in a `data/` folder and, if you are keeping your code in a git repository, add `*data*` to your `.gitignore` file so git doesnâ€™t track them.

```{r}
#install.packages("rasterVis")
#install.packages("ncdf4")
install.packages("tidyterra")
library(terra)
library(tidyverse)
library(sf)
library(knitr)
library(kableExtra)
library(rasterVis)
library(ncdf4)
library(lubridate)
library(tidyterra)

dir.create("data", showWarnings = FALSE)

lulc_url <- "https://github.com/adammwilson/DataScienceData/blob/master/inst/extdata/appeears/MCD12Q1.051_aid0001.nc?raw=true"
lst_url <- "https://github.com/adammwilson/DataScienceData/blob/master/inst/extdata/appeears/MOD11A2.006_aid0001.nc?raw=true"

download.file(lulc_url, destfile = "data/MCD12Q1.051_aid0001.nc", mode = "wb")
download.file(lst_url, destfile = "data/MOD11A2.006_aid0001.nc", mode = "wb")
```
Load and Explore the Data
ðŸ’¡ Hints:

Use nc_open() to print the file metadata and learn the names of the subdataset
Use rast() to read the NetCDF file and specify which subdatasets. (sbds) you want to select.
Check layer names with names().
Use plot() or gplot() to visualize the rasters.

```{r}
MCD12Q1 <- nc_open("data/MCD12Q1.051_aid0001.nc")
MOD11A2 <- nc_open("data/MOD11A2.006_aid0001.nc")

lulc <- rast("data/MCD12Q1.051_aid0001.nc", subds = "Land_Cover_Type_1")

names(lulc)

plot(lulc$Land_Cover_Type_1_13, main = "MODIS Land Cover (Year 13)")

lst <- rast("data/MOD11A2.006_aid0001.nc", subds ="LST_Day_1km")

names(lst)

names(lst)

plot(lst)
```
# **Convert and Label Land Cover**

```{r}

Land_Cover_Type_1 <- c(
  "Water" = 0, "Evergreen Needleleaf forest" = 1, "Evergreen Broadleaf forest" = 2,
  "Deciduous Needleleaf forest" = 3, "Deciduous Broadleaf forest" = 4, "Mixed forest" = 5,
  "Closed shrublands" = 6, "Open shrublands" = 7, "Woody savannas" = 8, "Savannas" = 9,
  "Grasslands" = 10, "Permanent wetlands" = 11, "Croplands" = 12, "Urban & built-up" = 13,
  "Cropland/Natural vegetation mosaic" = 14, "Snow & ice" = 15, "Barren/Sparsely vegetated" = 16
)

lcd <- data.frame(
  ID = Land_Cover_Type_1,
  landcover = names(Land_Cover_Type_1),
  stringsAsFactors = FALSE
)

lulc <- as.factor(lulc)

scoff(lst) = cbind(0.02, -273.15)

plot(lst, main = "Surface Temperature (C)")

```
Part 1: Extract Time Series for a Point
Hint
Use extract() to get the average LST for a location in Buffalo, NY.

ðŸ’¡ Hints:

Create a point with st_as_sf() to create a point at lon = -78.79, lat = 43.00 in wgs84 (geographic) coordinates (crs = 4326)
Transform to the rasterâ€™s CRS with st_transform().
Use terra::extract() to extract LST values within a 1 km buffer.
Combine with the corresponding time(lst) values into a tidy data frame.
Plot the result with ggplot().
`geom_smooth()` using method = 'loess' and formula = 'y ~ x'

```{r}

buff_point <- data.frame(lon = -78.79, lat = 43.00)

buff_point_sf <- st_as_sf(buff_point, coords = c("lon", "lat"), crs = 4326)

buff_point_sf <- st_transform(buff_point_sf, st_crs(lst))

extracted_lst <- terra::extract(lst, buff_point_sf)

time_lst <- time(lst)

combined_lst <- extracted_lst %>% 
  rbind(time_lst)

fixed_combined <- t(combined_lst)

fixed_combined <- as.data.frame(fixed_combined)

fixed_combined <- fixed_combined %>%
  rename(year = V2) %>%
  rename(temp = V1)

fixed_combined <- fixed_combined %>%
  mutate(year = as.Date(year))

ggplot(fixed_combined, aes(x = year, y = temp)) + geom_point() + geom_smooth(method = "loess", formula = "y ~ x", span = 0.01) + labs(title = "Time Series of LST Near Buffalo. NY", x = "Date", y = "Land Surface Temperature (Degrees C)")

```
Part 2: Monthly Climatology
Hint
Summarize the weekly data into monthly means using tapp().

ðŸ’¡ Hints:

Use index = "months" and fun = mean in tapp().
Rename layers to month names. You could use month.name[...] or find another way to do it.
Visualize with a ggplot using tidyterra::geom_spatraster and facet_wrap(~lyr) to compare months.
```{r}

monthly_lst <- tapp(lst, fun=mean, index="months", na.rm=TRUE)

names(monthly_lst)

names(monthly_lst) <- c(month.name)

summary(monthly_lst)

terra::values(monthly_lst)

ggplot(monthly_lst) + geom_spatraster(data = monthly_lst) + stat_spatraster(data = monthly_lst) + facet_wrap(~lyr) + scale_fill_gradientn(colors = c("blue", "gray", "red"))

```


Part 3: Compare LST by Land Cover Type

Challenge
Explore how LST differs between Urban & built-up and Deciduous Broadleaf Forest areas.

ðŸ’¡ Hints:

Resample the land cover raster to match LST resolution with resample(method = "near").
Extract values from both rasters into a combined data frame. You could use bind_cols() or other methods.
Join land cover names from the MODIS legend table.
Filter to the two land cover types of interest (c("Urban & built-up", "Deciduous Broadleaf forest")) and plot monthly distributions.

```{r}
lulc <- resample(lulc, lst, method = "near")

lulc_lst_all <- c(lst, lulc_data)

lulc_lst_all <- as.data.frame(lulc_lst_all)
  
#lulc_lst_filtered <- lulc_lst_all %>% 
 # pivot_longer(cols=c("January":"December"), values_to = "temperature", names_to = "month") %>%
  # group_by(month)

ggplot(data = monthly_lst_filtered, aes(x = month, y = temperature)) + geom_violin()
```


